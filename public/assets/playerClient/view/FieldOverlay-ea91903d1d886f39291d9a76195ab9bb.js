/*
 * File: app/view/FieldOverlay.js
 */
//------------------------------------------------------------------------------
Ext.define("Biofuels.view.FieldOverlay",{attachTo:function(e,t,n,r){this.surface=t,this.fieldData=e,this.atX=n,this.atY=r,this.soilScalar=1.5,this.yieldPos={x:n+20,y:r+55},this.underlay=t.add([{type:"rect",width:160,height:120,radius:10,x:n,y:r,fill:"#ff0",opacity:.5,zIndex:500}]),this.cropSprites={corn:"resources/corn_icon.png",switchgrass:"resources/grass_icon.png",coverCrop:"resources/cover_crop_icon.png"},this.cropSprite=t.add([{type:"image",src:"resources/corn_icon.png",x:n-15,y:r-15,width:40,height:40,zIndex:3e3}]),this.fertilizerSprite=t.add([{type:"image",src:"resources/fertilizer_yes_icon.png",x:n-10,y:r+25,width:30,height:30,zIndex:3e3}]),this.tillSprite=t.add([{type:"image",src:"resources/till_yes_icon.png",x:n-10,y:r+55,width:30,height:30,zIndex:3e3}]);var i="M"+(n+20)+" "+this.yieldPos.y+"L",s=120/(this.fieldData.seasons.length-1);for(var o=0;o<this.fieldData.seasons.length;o++)i+=this.yieldPos.x+s*o+" "+(this.yieldPos.y+this.fieldData.seasons[o].soil*-this.soilScalar)+" ";var u="M"+this.yieldPos.x+" "+(r+15)+"v85 h120 v-85",a="M"+this.yieldPos.x+" "+this.yieldPos.y+"h120",f="M"+this.yieldPos.x+" "+(r+15)+"v85 h120 v-85z";this.yieldGridBG=t.add([{type:"path",path:f,"stroke-width":0,fill:"#ffa",opacity:.5,zIndex:4e3}]),this.yieldGrid=t.add([{type:"path",path:u,stroke:"#000","stroke-width":1,opacity:.6,zIndex:4500},{type:"path",path:a,stroke:"#000","stroke-width":1,opacity:.6,zIndex:4500}]),this.yieldPath=t.add([{type:"path",path:i,stroke:"#fff","stroke-width":2,zIndex:5e3}]),this.yieldMarker=t.add([{type:"circle",radius:3,stroke:"#ed3","stroke-width":1,fill:"#346",x:this.yieldPos.x,y:this.yieldPos.y,zIndex:6e3}])},animateShow:function(e,t,n){e.stopAnimation().show(!0).animate({duration:t,to:{opacity:n}})},doHide:function(){this.hide(!0)},animateHide:function(e){e.stopAnimation().animate({duration:100,to:{opacity:0},callback:this.doHide,scope:e})},showYields:function(){this.animateShow(this.yieldGrid[0],100,.6),this.animateShow(this.yieldGrid[1],100,.3),this.animateShow(this.yieldGridBG[0],100,.5),this.animateShow(this.yieldPath[0],100,1),this.animateShow(this.yieldMarker[0],100,1)},hideYields:function(){this.animateHide(this.yieldGrid[0]),this.animateHide(this.yieldGrid[1]),this.animateHide(this.yieldGridBG[0]),this.animateHide(this.yieldPath[0]),this.animateHide(this.yieldMarker[0])},showSoilHealth:function(){this.animateShow(this.underlay[0],100,.5)},hideSoilHealth:function(){this.animateHide(this.underlay[0])},showCrop:function(){this.animateShow(this.cropSprite[0],200,1),this.animateShow(this.fertilizerSprite[0],200,1),this.animateShow(this.tillSprite[0],200,1)},hideCrop:function(){this.animateHide(this.cropSprite[0]),this.animateHide(this.fertilizerSprite[0]),this.animateHide(this.tillSprite[0])},show:function(e){this.showSoilHealth(),this.showCrop(),this.showYields()},hide:function(){this.hideSoilHealth(),this.hideCrop(),this.hideYields()},animateTo:function(e,t,n,r){var i;r&&typeof r!="undefined"?i.duration=r:i.duration=100,t&&(i.to.opacity=t),n&&(i.to.fill=n),e.stopAnimation().animate(i)},setCurrentSeason:function(e){var t=this.fieldData.seasons.length-1+e,n=this.fieldData.seasons[t],r="#ff0";n.soil<=-10?r="#f00":n.soil>=10?r="#0f0":n.soil<0?r="rgb(255,"+(255+n.soil*25)+",0)":n.soil>0&&(r="rgb("+(255-n.soil*25)+",255,0)"),this.underlay[0].stopAnimation().animate({duration:200,to:{fill:r,opacity:.5}}),this.cropSprite[0].setAttributes({src:this.cropSprites[n.crop]},!0);var i=120/(this.fieldData.seasons.length-1);this.yieldMarker[0].stopAnimation().animate({duration:200,to:{x:this.yieldPos.x+i*t,y:this.yieldPos.y+n.soil*-this.soilScalar,opacity:1}});var s=0;n.fertilizer&&(s=1),this.fertilizerSprite[0].stopAnimation().animate({duration:200,to:{opacity:s}}),s=0,n.till&&(s=1),this.tillSprite[0].stopAnimation().animate({duration:200,to:{opacity:s}})}});
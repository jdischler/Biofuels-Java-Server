/*
 * File: Biofuels/view/JoinGamePopup.js
 */
//
// Sends Events:
//		event: 'validateUserName'
//				roomName: 'name', password: 'pswd', userName: 'name'
//
// Receives Events:
//
//		event: 'validateUserName'
//				roomResult: 'true/false', needsPassword: 'true/false',
//				passwordResult: 'true/false', userNameResult: 'true/false'
//
//		event: 'joinRoom'
//				result: 'true/false'
//				errorMessage: 'errorMsg'
//------------------------------------------------------------------------------
Ext.define("Biofuels.view.JoinGamePopup",{extend:"Ext.window.Window",requires:["Ext.window.MessageBox"],height:230,width:360,layout:{type:"absolute"},closable:!1,modal:!0,title:"Join A Biofuels Game",initNetworkEvents:function(){var e=Biofuels;e.network.registerListener("validateUserName",this.manageLeds,this),e.network.registerListener("joinRoom",this.serverJoinRoomResult,this)},initComponent:function(){var e=this;this.initNetworkEvents(),Ext.applyIf(e,{items:[{xtype:"textfield",itemId:"roomName",x:20,y:30,fieldLabel:"Room Name",labelPad:5,labelWidth:100,labelAlign:"right",allowBlank:!1,blankText:"Required",enforceMaxLength:!0,maxLength:16,validator:Ext.bind(this.dirtyChange,this)},{xtype:"image",itemId:"roomLed",x:305,y:32,height:20,width:20,src:"resources/redLed.png"},{xtype:"textfield",itemId:"password",x:20,y:60,disabled:!0,fieldLabel:"Password",labelPad:5,labelWidth:100,labelAlign:"right",enforceMaxLength:!0,maxLength:16,validator:Ext.bind(this.dirtyChange,this)},{xtype:"image",itemId:"passwordLed",x:305,y:62,hidden:!0,height:20,width:20,src:"resources/redLed.png"},{xtype:"textfield",itemId:"userName",x:20,y:100,fieldLabel:"Farmer Name",labelPad:5,labelWidth:100,labelAlign:"right",enforceMaxLength:!0,maxLength:16,validator:Ext.bind(this.dirtyChange,this)},{xtype:"image",itemId:"userNameLed",x:305,y:102,height:20,width:20,src:"resources/redLed.png"},{xtype:"button",x:100,y:150,width:160,scale:"medium",text:"Join Game",enabled:!1,scope:this,handler:function(){this.tryJoinRoom()}}]}),e.callParent(arguments)},dirtyChange:function(e){var t=this.getComponent("roomName").value,n=this.getComponent("password").value,r=this.getComponent("userName").value;t=typeof t=="undefined"||t.length<1?"":t,n=typeof n=="undefined"||n.length<1?"":n,r=typeof r=="undefined"||r.length<1?"":r;var i=Biofuels,s={event:"validateUserName",roomName:t,password:n,userName:r};return i.network.send(JSON.stringify(s)),!0},manageLeds:function(e){var t=this.getComponent("roomLed"),n=e.roomResult;n?t.setSrc("resources/greenLed.png"):t.setSrc("resources/redLed.png"),t=this.getComponent("passwordLed"),password=this.getComponent("password");var r=e.passwordResult;!n||!e.needsPassword?(password.setDisabled(!0),t.setVisible(!1)):(password.setDisabled(!1),t.setVisible(!0)),r&&n?t.setSrc("resources/greenLed.png"):t.setSrc("resources/redLed.png"),t=this.getComponent("userNameLed"),e.userNameResult?t.setSrc("resources/greenLed.png"):t.setSrc("resources/redLed.png")},tryJoinRoom:function(){var e=this.getComponent("roomName").value,t=this.getComponent("password").value,n=this.getComponent("userName").value;if(typeof e=="undefined"||typeof n=="undefined"){Ext.MessageBox.alert("Data Required","A valid room name and farmer name are required.");var e=this.getComponent("roomName").focus(!0,!0);return}e=typeof e=="undefined"||e.length<1?"":e,t=typeof t=="undefined"||t.length<1?"":t,n=typeof n=="undefined"||n.length<1?"":n,Biofuels.farmerName=n;var r={event:"joinRoom",roomName:e,password:t,userName:n};console.log("Trying to join the room!"),WsConnection.webSocket.gameChannel=e,Biofuels.network.send(JSON.stringify(r))},serverJoinRoomResult:function(e){console.log("server join room result called!");if(e.result){Biofuels.network.subscribe(e.roomName);var t={event:"loadFromServer",roomName:e.roomName};Biofuels.network.send(JSON.stringify(t)),this.close()}else Ext.MessageBox.alert("Join Room Error",e.errorMessage)}});